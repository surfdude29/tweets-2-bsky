<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweets-2-Bsky Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .btn-primary { background-color: #0085ff; border: none; border-radius: 8px; }
        .btn-primary:hover { background-color: #0072db; }
        .login-container { max-width: 400px; margin: 100px auto; }
        .owner-badge { background-color: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        
        /* Dark mode custom refinements */
        [data-bs-theme="dark"] body { background-color: #0f172a; }
        [data-bs-theme="dark"] .card { background-color: #1e293b; border: 1px solid #334155; }
        [data-bs-theme="dark"] .navbar { background-color: #1e293b; border-bottom: 1px solid #334155; }
        [data-bs-theme="dark"] .owner-badge { background-color: rgba(255,255,255,0.1); color: #cbd5e1; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-active { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
        .status-queued { background-color: #eab308; box-shadow: 0 0 8px rgba(234, 179, 8, 0.4); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('darkMode') === 'true');
            const [view, setView] = useState(localStorage.getItem('token') ? 'dashboard' : 'login');
            const [mappings, setMappings] = useState([]);
            const [twitterConfig, setTwitterConfig] = useState({ authToken: '', ct0: '' });
            const [isAdmin, setIsAdmin] = useState(false);
            const [status, setStatus] = useState({});
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [countdown, setCountdown] = useState('');
            
            // Edit Modal State
            const [editingMapping, setEditingMapping] = useState(null);

            const handleLogout = useCallback(() => {
                localStorage.removeItem('token');
                setToken(null);
                setView('login');
                setIsAdmin(false);
            }, []);

            const fetchStatus = useCallback(async () => {
                if (!token) return;
                try {
                    const res = await axios.get('/api/status', { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    setStatus(res.data);
                } catch (err) {
                    console.error('Failed to fetch status');
                    if (err.response?.status === 401) handleLogout();
                }
            }, [token, handleLogout]);

            const fetchData = useCallback(async () => {
                if (!token) return;
                try {
                    const headers = { Authorization: `Bearer ${token}` };
                    const [meRes, mapRes] = await Promise.all([
                        axios.get('/api/me', { headers }),
                        axios.get('/api/mappings', { headers })
                    ]);
                    setIsAdmin(meRes.data.isAdmin);
                    setMappings(mapRes.data);
                    if (meRes.data.isAdmin) {
                        const twitRes = await axios.get('/api/twitter-config', { headers });
                        setTwitterConfig(twitRes.data);
                    }
                    fetchStatus();
                } catch (err) {
                    console.error('Failed to fetch data', err);
                    if (err.response?.status === 401) handleLogout();
                }
            }, [token, fetchStatus, handleLogout]);

            useEffect(() => {
                document.documentElement.setAttribute('data-bs-theme', darkMode ? 'dark' : 'light');
                localStorage.setItem('darkMode', darkMode);
            }, [darkMode]);

            useEffect(() => {
                if (token) {
                    fetchData();
                    setView('dashboard');
                } else {
                    setView('login');
                }
            }, [token, fetchData]);

            useEffect(() => {
                if (view !== 'dashboard' || !token) return;
                
                const statusTimer = setInterval(fetchStatus, 30000);
                return () => clearInterval(statusTimer);
            }, [view, token, fetchStatus]);

            useEffect(() => {
                if (!status.nextCheckTime) return;

                const updateCountdown = () => {
                    const diff = status.nextCheckTime - Date.now();
                    if (diff <= 0) {
                        setCountdown('Soon...');
                        return;
                    }
                    const mins = Math.floor(diff / 60000);
                    const secs = Math.floor((diff % 60000) / 1000);
                    setCountdown(`${mins}m ${secs}s`);
                };

                updateCountdown();
                const timer = setInterval(updateCountdown, 1000);
                return () => clearInterval(timer);
            }, [status.nextCheckTime]);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    const res = await axios.post('/api/login', { email, password });
                    localStorage.setItem('token', res.data.token);
                    setToken(res.data.token);
                    setIsAdmin(res.data.isAdmin);
                } catch (err) {
                    setError('Invalid credentials');
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    await axios.post('/api/register', { email, password });
                    setView('login');
                    alert('Registration successful! Please login.');
                } catch (err) {
                    setError('User already exists');
                }
            };

            const addMapping = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(e.target);
                try {
                    await axios.post('/api/mappings', {
                        owner: formData.get('owner'),
                        twitterUsernames: formData.get('twitterUsernames'),
                        bskyIdentifier: formData.get('bskyIdentifier'),
                        bskyPassword: formData.get('bskyPassword'),
                        bskyServiceUrl: formData.get('bskyServiceUrl')
                    }, { headers: { Authorization: `Bearer ${token}` } });
                    fetchData();
                    e.target.reset();
                } catch (err) {
                    alert('Failed to add mapping');
                }
                setLoading(false);
            };

            const updateMapping = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(e.target);
                try {
                    await axios.put(`/api/mappings/${editingMapping.id}`, {
                        owner: formData.get('owner'),
                        twitterUsernames: formData.get('twitterUsernames'),
                        bskyIdentifier: formData.get('bskyIdentifier'),
                        bskyPassword: formData.get('bskyPassword'),
                        bskyServiceUrl: formData.get('bskyServiceUrl')
                    }, { headers: { Authorization: `Bearer ${token}` } });
                    fetchData();
                    setEditingMapping(null);
                } catch (err) {
                    alert('Failed to update mapping');
                }
                setLoading(false);
            };

            const deleteMapping = async (id) => {
                if (!confirm('Are you sure?')) return;
                try {
                    await axios.delete(`/api/mappings/${id}`, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    fetchData();
                } catch (err) {
                    alert('Failed to delete');
                }
            };

            const runNow = async () => {
                if (!confirm('Run check now for all accounts?')) return;
                try {
                    await axios.post('/api/run-now', {}, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    alert('Check triggered!');
                    setTimeout(fetchStatus, 1000);
                } catch (err) {
                    alert('Failed to trigger check');
                }
            };

            const runBackfill = async (id, twitterUsernames) => {
                // If multiple usernames, we could ask which one, but backend handles "all for this mapping" currently
                // or we can prompt for a specific one if we want.
                // For simplicity, let's just trigger backfill for the mapping, which iterates all usernames.
                
                const limit = prompt(`How many tweets to backfill per account?`, "15");
                if (limit === null) return;
                
                try {
                    await axios.post(`/api/backfill/${id}`, { limit: parseInt(limit) || 15 }, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    alert(`Backfill queued`);
                    setTimeout(fetchStatus, 1000);
                } catch (err) {
                    alert(err.response?.data?.error || 'Failed to queue backfill');
                }
            };

            const cancelBackfill = async (id) => {
                try {
                    await axios.delete(`/api/backfill/${id}`, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    fetchStatus();
                } catch (err) {
                    alert('Failed to cancel backfill');
                }
            };

            const clearAllBackfills = async () => {
                if (!confirm('Stop all pending and running backfills?')) return;
                try {
                    await axios.post('/api/backfill/clear-all', {}, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    fetchStatus();
                } catch (err) {
                    alert('Failed to clear backfills');
                }
            };

            const clearCache = async (id) => {
                if (!confirm(`Clear processed tweets cache for all accounts in this mapping?`)) return;
                try {
                    await axios.delete(`/api/mappings/${id}/cache`, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    alert(`Cache cleared`);
                } catch (err) {
                    alert('Failed to clear cache');
                }
            };

            const resetAndBackfill = async (id) => {
                const limit = prompt(`Reset cache and backfill how many tweets?`, "15");
                if (limit === null) return;

                try {
                    await axios.delete(`/api/mappings/${id}/cache`, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    await axios.post(`/api/backfill/${id}`, { limit: parseInt(limit) || 15 }, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    alert(`Cache cleared and backfill queued`);
                    setTimeout(fetchStatus, 1000);
                } catch (err) {
                    alert('Reset & Backfill failed');
                }
            };

            const updateTwitter = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                    await axios.post('/api/twitter-config', {
                        authToken: formData.get('authToken'),
                        ct0: formData.get('ct0')
                    }, { headers: { Authorization: `Bearer ${token}` } });
                    alert('Twitter config updated!');
                    fetchData();
                } catch (err) {
                    alert('Failed to update twitter config');
                }
            };

            if (view === 'login' || view === 'register' || !token) {
                return (
                    <div className="container login-container">
                        <div className="card p-4">
                            <h2 className="text-center mb-4">{view === 'login' ? 'Login' : 'Register'}</h2>
                            {error && <div className="alert alert-danger">{error}</div>}
                            <form onSubmit={view === 'login' ? handleLogin : handleRegister}>
                                <div className="mb-3">
                                    <label className="form-label">Email</label>
                                    <input name="email" type="email" className="form-control" required />
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Password</label>
                                    <input name="password" type="password" className="form-control" required />
                                </div>
                                <button type="submit" className="btn btn-primary w-100 mb-3">
                                    {view === 'login' ? 'Login' : 'Register'}
                                </button>
                                <div className="text-center">
                                    <a href="#" className="btn btn-link" onClick={() => setView(view === 'login' ? 'register' : 'login')}>
                                        {view === 'login' ? 'Need an account? Register' : 'Have an account? Login'}
                                    </a>
                                </div>
                            </form>
                            <div className="text-center mt-3">
                                <button className="btn btn-outline-secondary btn-sm" onClick={() => setDarkMode(!darkMode)}>
                                    {darkMode ? 'Light Mode' : 'Dark Mode'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const isBackfillQueued = (id) => status.pendingBackfills?.some(b => (b.id || b) === id);

            return (
                <div>
                    <nav className="navbar navbar-expand-lg mb-4">
                        <div className="container">
                            <span className="navbar-brand d-flex align-items-center">
                                <span className="material-icons me-2 text-primary">swap_calls</span>
                                <strong>Tweets-2-Bsky</strong>
                            </span>
                            <div className="d-flex align-items-center gap-3">
                                <span className="text-muted small">
                                    Next: <span className={darkMode ? 'text-light' : 'text-dark'}>{countdown}</span>
                                </span>
                                <button className="btn btn-outline-secondary btn-sm" onClick={runNow}>
                                    Run Now
                                </button>
                                {isAdmin && status.pendingBackfills?.length > 0 && (
                                    <button className="btn btn-outline-danger btn-sm" onClick={clearAllBackfills}>
                                        Stop All Backfills ({status.pendingBackfills.length})
                                    </button>
                                )}
                                <button className="btn btn-outline-secondary btn-sm" onClick={() => setDarkMode(!darkMode)}>
                                    {darkMode ? 'Light' : 'Dark'}
                                </button>
                                <button className="btn btn-outline-danger btn-sm" onClick={handleLogout}>Logout</button>
                            </div>
                        </div>
                    </nav>

                    <div className="container">
                        {status.currentStatus && status.currentStatus.state !== 'idle' && (
                            <div className="row mb-4">
                                <div className="col-12">
                                    <div className={`card p-3 border-start border-4 ${status.currentStatus.state === 'backfilling' ? 'border-warning' : 'border-primary'}`}>
                                        <div className="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 className="mb-1 d-flex align-items-center text-capitalize">
                                                    <div className="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                                    {status.currentStatus.state} 
                                                    {status.currentStatus.currentAccount && ` - @${status.currentStatus.currentAccount}`}
                                                </h6>
                                                <div className="text-muted small">
                                                    {status.currentStatus.message}
                                                </div>
                                            </div>
                                            {status.currentStatus.totalCount > 0 && (
                                                <div className="text-end">
                                                    <div className="h4 mb-0">{Math.round((status.currentStatus.processedCount / status.currentStatus.totalCount) * 100)}%</div>
                                                    <div className="text-muted small">{status.currentStatus.processedCount} / {status.currentStatus.totalCount}</div>
                                                </div>
                                            )}
                                        </div>
                                        {status.currentStatus.totalCount > 0 && (
                                            <div className="progress mt-2" style={{ height: '4px' }}>
                                                <div 
                                                    className="progress-bar progress-bar-striped progress-bar-animated" 
                                                    style={{ width: `${(status.currentStatus.processedCount / status.currentStatus.totalCount) * 100}%` }}
                                                ></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="row">
                            {isAdmin && (
                            <div className="col-md-4 mb-4">
                                <div className="card p-3 mb-4">
                                    <h5 className="mb-3 d-flex align-items-center">
                                        <span className="material-icons me-2">settings</span> Twitter Config
                                    </h5>
                                    <form onSubmit={updateTwitter}>
                                        <div className="mb-3">
                                            <label className="form-label small">Auth Token</label>
                                            <input name="authToken" defaultValue={twitterConfig.authToken} className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label small">CT0</label>
                                            <input name="ct0" defaultValue={twitterConfig.ct0} className="form-control form-control-sm" required />
                                        </div>
                                        <button className="btn btn-primary btn-sm w-100">Update</button>
                                    </form>
                                </div>

                                <div className="card p-3">
                                    <h5 className="mb-3 d-flex align-items-center">
                                        <span className="material-icons me-2">add_circle</span> Add Account
                                    </h5>
                                    <form onSubmit={addMapping}>
                                        <div className="mb-2">
                                            <input name="owner" placeholder="Owner (e.g. My Brand)" className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-2">
                                            <input name="twitterUsernames" placeholder="Twitter Username(s) (comma separated)" className="form-control form-control-sm" required />
                                        </div>
                                        
                                        <div className="mt-3 mb-2">
                                            <label className="form-label small fw-bold text-muted">Bluesky Destination</label>
                                            {mappings.length > 0 && (
                                                <div className="mb-2">
                                                    <select 
                                                        className="form-select form-select-sm" 
                                                        onChange={(e) => {
                                                            if (e.target.value) {
                                                                const m = mappings.find(x => x.bskyIdentifier === e.target.value);
                                                                if (m) {
                                                                    const form = e.target.form;
                                                                    form.bskyIdentifier.value = m.bskyIdentifier;
                                                                    form.bskyPassword.value = m.bskyPassword;
                                                                    form.bskyServiceUrl.value = m.bskyServiceUrl;
                                                                }
                                                            }
                                                        }}
                                                    >
                                                        <option value="">-- Use Existing Bluesky Account --</option>
                                                        {[...new Set(mappings.map(m => m.bskyIdentifier))].map(id => (
                                                            <option key={id} value={id}>{id}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                            <input name="bskyIdentifier" placeholder="Bluesky Handle" className="form-control form-control-sm mb-2" required />
                                            <input name="bskyPassword" type="password" placeholder="App Password" className="form-control form-control-sm mb-2" required />
                                            <input name="bskyServiceUrl" defaultValue="https://bsky.social" className="form-control form-control-sm" />
                                        </div>
                                        
                                        <button className="btn btn-success btn-sm w-100" disabled={loading}>
                                            {loading ? 'Adding...' : 'Add Account Mapping'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                            )}

                            <div className={isAdmin ? "col-md-8" : "col-md-12"}>
                                <div className="card p-3">
                                    <h5 className="mb-4 d-flex align-items-center">
                                        <span className="material-icons me-2">list</span> Accounts
                                    </h5>
                                    {mappings.length === 0 && <p className="text-center text-muted">No accounts added.</p>}
                                    <div className="table-responsive">
                                        <table className="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Owner</th>
                                                    <th>Twitter Sources</th>
                                                    <th>Bluesky</th>
                                                    <th>Status</th>
                                                    <th className="text-end">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {mappings.map(m => (
                                                    <tr key={m.id}>
                                                        <td><span className="owner-badge">{m.owner || 'System'}</span></td>
                                                        <td>
                                                            {m.twitterUsernames.map(u => (
                                                                <span key={u} className="badge bg-secondary me-1">@{u}</span>
                                                            ))}
                                                        </td>
                                                        <td className="small text-muted">{m.bskyIdentifier}</td>
                                                        <td>
                                                            <span className={`status-dot ${isBackfillQueued(m.id) ? 'status-queued' : 'status-active'}`}></span>
                                                            {isBackfillQueued(m.id) ? 'Backfill' : 'Active'}
                                                            {isBackfillQueued(m.id) && (
                                                                <button onClick={() => cancelBackfill(m.id)} className="btn btn-link btn-sm text-danger p-0 ms-1" title="Stop Backfill">
                                                                    <span className="material-icons" style={{fontSize: '14px'}}>cancel</span>
                                                                </button>
                                                            )}
                                                        </td>
                                                        <td className="text-end">
                                                            {isAdmin && (
                                                            <>
                                                                <button onClick={() => setEditingMapping(m)} className="btn btn-link btn-sm text-primary p-0 me-2" title="Edit">
                                                                    <span className="material-icons">edit</span>
                                                                </button>
                                                                <button onClick={() => runBackfill(m.id, m.twitterUsernames)} className="btn btn-link btn-sm text-warning p-0 me-2" title="Backfill (Keep Cache)">
                                                                    <span className="material-icons">history</span>
                                                                </button>
                                                                <button onClick={() => resetAndBackfill(m.id, m.twitterUsernames)} className="btn btn-link btn-sm text-danger p-0 me-2" title="Reset & Backfill (Clears Cache)">
                                                                    <span className="material-icons">restart_alt</span>
                                                                </button>
                                                                <button onClick={() => clearCache(m.id, m.twitterUsernames)} className="btn btn-link btn-sm text-secondary p-0 me-2" title="Clear Cache Only">
                                                                    <span className="material-icons">delete_sweep</span>
                                                                </button>
                                                            </>
                                                            )}
                                                            <button onClick={() => deleteMapping(m.id)} className="btn btn-link btn-sm text-danger p-0" title="Delete Account">
                                                                <span className="material-icons">delete</span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Edit Modal */}
                    {editingMapping && (
                        <div className="modal d-block" style={{backgroundColor: 'rgba(0,0,0,0.5)'}} tabIndex="-1">
                          <div className="modal-dialog">
                            <div className="modal-content">
                              <div className="modal-header">
                                <h5 className="modal-title">Edit Mapping</h5>
                                <button type="button" className="btn-close" onClick={() => setEditingMapping(null)}></button>
                              </div>
                              <form onSubmit={updateMapping}>
                                  <div className="modal-body">
                                        <div className="mb-3">
                                            <label className="form-label">Owner</label>
                                            <input name="owner" defaultValue={editingMapping.owner} className="form-control" required />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Twitter Usernames (comma separated)</label>
                                            <input name="twitterUsernames" defaultValue={editingMapping.twitterUsernames.join(', ')} className="form-control" required />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Bluesky Handle</label>
                                            <input name="bskyIdentifier" defaultValue={editingMapping.bskyIdentifier} className="form-control" required />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Bluesky App Password (leave blank to keep current)</label>
                                            <input name="bskyPassword" type="password" className="form-control" />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Service URL</label>
                                            <input name="bskyServiceUrl" defaultValue={editingMapping.bskyServiceUrl} className="form-control" />
                                        </div>
                                  </div>
                                  <div className="modal-footer">
                                    <button type="button" className="btn btn-secondary" onClick={() => setEditingMapping(null)}>Close</button>
                                    <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? 'Saving...' : 'Save changes'}</button>
                                  </div>
                              </form>
                            </div>
                          </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
