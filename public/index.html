<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweets-2-Bsky Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .navbar { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .btn-primary { background-color: #0085ff; border: none; border-radius: 8px; }
        .btn-primary:hover { background-color: #0072db; }
        .login-container { max-width: 400px; margin: 100px auto; }
        .owner-badge { background-color: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [view, setView] = useState('login'); // login, register, dashboard
            const [mappings, setMappings] = useState([]);
            const [twitterConfig, setTwitterConfig] = useState({ authToken: '', ct0: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                if (token) {
                    fetchData();
                    setView('dashboard');
                }
            }, [token]);

            const fetchData = async () => {
                try {
                    const headers = { Authorization: `Bearer ${token}` };
                    const [mapRes, twitRes] = await Promise.all([
                        axios.get('/api/mappings', { headers }),
                        axios.get('/api/twitter-config', { headers })
                    ]);
                    setMappings(mapRes.data);
                    setTwitterConfig(twitRes.data);
                } catch (err) {
                    if (err.response?.status === 401) handleLogout();
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const res = await axios.post('/api/login', { 
                        email: e.target.email.value, 
                        password: e.target.password.value 
                    });
                    localStorage.setItem('token', res.data.token);
                    setToken(res.data.token);
                } catch (err) {
                    setError('Invalid credentials');
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await axios.post('/api/register', { 
                        email: e.target.email.value, 
                        password: e.target.password.value 
                    });
                    setView('login');
                    alert('Registration successful! Please login.');
                } catch (err) {
                    setError('User already exists');
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('token');
                setToken(null);
                setView('login');
            };

            const addMapping = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const headers = { Authorization: `Bearer ${token}` };
                    await axios.post('/api/mappings', {
                        owner: e.target.owner.value,
                        twitterUsername: e.target.twitterUsername.value,
                        bskyIdentifier: e.target.bskyIdentifier.value,
                        bskyPassword: e.target.bskyPassword.value,
                        bskyServiceUrl: e.target.bskyServiceUrl.value
                    }, { headers });
                    fetchData();
                    e.target.reset();
                } catch (err) {
                    alert('Failed to add mapping');
                }
                setLoading(false);
            };

            const deleteMapping = async (id) => {
                if (!confirm('Are you sure?')) return;
                try {
                    await axios.delete(`/api/mappings/${id}`, { 
                        headers: { Authorization: `Bearer ${token}` } 
                    });
                    fetchData();
                } catch (err) {
                    alert('Failed to delete');
                }
            };

            const updateTwitter = async (e) => {
                e.preventDefault();
                try {
                    await axios.post('/api/twitter-config', {
                        authToken: e.target.authToken.value,
                        ct0: e.target.ct0.value
                    }, { headers: { Authorization: `Bearer ${token}` } });
                    alert('Global Twitter config updated!');
                    fetchData();
                } catch (err) {
                    alert('Failed to update twitter config');
                }
            };

            if (!token) {
                return (
                    <div className="container login-container">
                        <div className="card p-4">
                            <h2 className="text-center mb-4">{view === 'login' ? 'Login' : 'Register'}</h2>
                            {error && <div className="alert alert-danger">{error}</div>}
                            <form onSubmit={view === 'login' ? handleLogin : handleRegister}>
                                <div className="mb-3">
                                    <label className="form-label">Email</label>
                                    <input name="email" type="email" className="form-control" required />
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Password</label>
                                    <input name="password" type="password" className="form-control" required />
                                </div>
                                <button type="submit" className="btn btn-primary w-100 mb-3">
                                    {view === 'login' ? 'Login' : 'Register'}
                                </button>
                                <div className="text-center">
                                    <a href="#" onClick={() => setView(view === 'login' ? 'register' : 'login')}>
                                        {view === 'login' ? 'Need an account? Register' : 'Have an account? Login'}
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <nav className="navbar navbar-expand-lg mb-4">
                        <div className="container">
                            <span className="navbar-brand d-flex align-items-center">
                                <span className="material-icons me-2 text-primary">swap_calls</span>
                                <strong>Tweets-2-Bsky</strong>
                            </span>
                            <button className="btn btn-outline-danger btn-sm" onClick={handleLogout}>Logout</button>
                        </div>
                    </nav>

                    <div className="container">
                        <div className="row">
                            {/* Left Column: Twitter Config */}
                            <div className="col-md-4 mb-4">
                                <div className="card p-3 mb-4">
                                    <h5 className="mb-3 d-flex align-items-center">
                                        <span className="material-icons me-2">settings</span> Global Twitter Config
                                    </h5>
                                    <p className="text-muted small">This one set of cookies is used for all crossposting tasks. Recommend using a burner account.</p>
                                    <form onSubmit={updateTwitter}>
                                        <div className="mb-3">
                                            <label className="form-label small">Auth Token</label>
                                            <input name="authToken" defaultValue={twitterConfig.authToken} className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label small">CT0</label>
                                            <input name="ct0" defaultValue={twitterConfig.ct0} className="form-control form-control-sm" required />
                                        </div>
                                        <button className="btn btn-primary btn-sm w-100">Update Cookies</button>
                                    </form>
                                </div>

                                <div className="card p-3">
                                    <h5 className="mb-3 d-flex align-items-center">
                                        <span className="material-icons me-2">add_circle</span> Add New Mapping
                                    </h5>
                                    <form onSubmit={addMapping}>
                                        <div className="mb-2">
                                            <input name="owner" placeholder="Owner Name (e.g. Dan)" className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-2">
                                            <input name="twitterUsername" placeholder="Twitter Username" className="form-control form-control-sm" required />
                                        </div>
                                        <hr/>
                                        <div className="mb-2">
                                            <input name="bskyIdentifier" placeholder="Bluesky Handle/Email" className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-2">
                                            <input name="bskyPassword" type="password" placeholder="Bluesky App Password" className="form-control form-control-sm" required />
                                        </div>
                                        <div className="mb-3">
                                            <input name="bskyServiceUrl" defaultValue="https://bsky.social" className="form-control form-control-sm" required />
                                        </div>
                                        <button className="btn btn-success btn-sm w-100" disabled={loading}>
                                            {loading ? 'Adding...' : 'Add Account'}
                                        </button>
                                    </form>
                                </div>
                            </div>

                            {/* Right Column: Active Mappings */}
                            <div className="col-md-8">
                                <div className="card p-3">
                                    <h5 className="mb-4 d-flex align-items-center">
                                        <span className="material-icons me-2">list</span> Active Sync Tasks
                                    </h5>
                                    {mappings.length === 0 && <p className="text-center text-muted">No accounts added yet.</p>}
                                    <div className="table-responsive">
                                        <table className="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Owner</th>
                                                    <th>Twitter</th>
                                                    <th>Bluesky</th>
                                                    <th>Status</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {mappings.map(m => (
                                                    <tr key={m.id}>
                                                        <td><span className="owner-badge">{m.owner || 'System'}</span></td>
                                                        <td>@{m.twitterUsername}</td>
                                                        <td className="small text-muted">{m.bskyIdentifier}</td>
                                                        <td><span className="badge bg-success">Active</span></td>
                                                        <td className="text-end">
                                                            <button onClick={() => deleteMapping(m.id)} className="btn btn-link text-danger p-0">
                                                                <span className="material-icons">delete</span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
